{% extends 'authenticated_base.html' %}
{% load static %}

{% block title %}Checkout - Sitwell{% endblock %}

{% block extra_css %}
<style>
    :root {
        /* 3-5 color palette */
        --bg-cream: #FFF9E8;
        --text: #1F2937;
        --muted: #6B7280;
        --line: #E5E7EB;
        --brand: #FACC15; /* yellow */
        --action: #2563EB; /* blue */
        --surface: #FFFFFF;
        --radius: 12px;
    }

    /* Reset + base */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial;
        color: var(--text);
        background: var(--bg-cream);
        line-height: 1.55;
    }
    h1, h2, h3 { margin: 0 0 .5rem; }
    h2 { font-size: 1.125rem; }
    h3 { font-size: 1rem; }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 48px;
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    /* Two columns */
    .cols {
        display: flex;
        gap: 24px;
        align-items: flex-start;
    }
    .left { flex: 1 1 640px; min-width: 0; }
    .right { flex: 0 0 360px; }

    /* Cards */
    .card {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        padding: 16px;
    }
    .section-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
    }
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 1px solid transparent;
        border-radius: 10px;
        padding: 8px 12px;
        background: var(--brand);
        color: #1a1a1a;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
    }
    .btn:focus-visible { outline: 3px solid #000; outline-offset: 2px; }

    /* Address card */
    .address-wrap { display: flex; flex-direction: column; gap: 8px; }
    .address-card {
        border: 2px solid var(--line);
        border-radius: 10px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        background: #F8FBFF;
        cursor: pointer;
        transition: border-color .2s, background-color .2s;
    }
    .address-card.selected { border-color: var(--action); }
    .address-card.selected .badge { background: var(--action); color: #fff; border-color: var(--action); }
    .row {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
    }
    .row.inline { display: inline-flex; }
    .icon {
        width: 18px;
        height: 18px;
        flex: 0 0 18px;
        color: var(--muted);
    }
    .muted { color: var(--muted); }
    .badge {
        display: inline-flex;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: .75rem;
        background: #FEF3C7;
        border: 1px solid #FDE68A;
        color: #92400E;
        margin-left: 8px;
    }
    .meta {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: auto;
        font-size: .875rem;
    }
    .meta a {
        color: var(--action);
        text-decoration: none;
        font-weight: 600;
    }
    .meta .dot {
        width: 4px;
        height: 4px;
        background: #D1D5DB;
        border-radius: 50%;
    }

    /* Payment methods */
    .methods { display: flex; flex-direction: column; gap: 10px; }
    .method {
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 12px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        transition: border-color .2s, background-color .2s;
    }
    .method:hover { border-color: #CBD5E1; }
    .radio {
        margin-top: 3px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        border: 2px solid #94A3B8;
        border-radius: 50%;
        background: #fff;
        flex: 0 0 18px;
    }
    .radio-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: transparent;
    }
    .method.is-active { border-color: var(--action); background: #F8FBFF; }
    .method.is-active .radio { border-color: var(--action); }
    .method.is-active .radio-dot { background: var(--action); }
    .method.disabled { opacity: 0.5; cursor: not-allowed; }
    .method-title {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
    }
    .method-sub { font-size: .9rem; color: var(--muted); margin-top: 2px; }

    /* Right column */
    .summary .item {
        display: flex;
        gap: 12px;
        padding: 10px 0;
        border-bottom: 1px solid var(--line);
    }
    .summary .item:last-child { border-bottom: none; }
    .summary .thumb {
        width: 54px;
        height: 54px;
        border-radius: 8px;
        object-fit: cover;
        border: 1px solid var(--line);
        flex: 0 0 54px;
    }
    .coupon { display: flex; gap: 8px; margin-top: 6px; }
    .input {
        flex: 1;
        min-width: 0;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px 12px;
        background: #fff;
    }
    .input:focus {
        outline: none;
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(245, 204, 21, 0.1);
    }
    .btn-gray {
        background: #F3F4F6;
        color: #111;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px 14px;
        font-weight: 600;
    }
    .btn-gray:hover { background: #E5E7EB; }
    .price-row { display: flex; justify-content: space-between; margin: 8px 0; font-size: .95rem; }
    .price-row.muted { color: var(--muted); }
    .price-row.total { font-weight: 800; font-size: 1.05rem; }
    .price-row.discount { color: #059669; }
    .cta {
        display: block;
        width: 100%;
        margin-top: 12px;
        padding: 14px 16px;
        background: var(--action);
        color: #fff;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
    }
    .cta:hover { background: #1D4ED8; }
    .view-coupons {
        color: var(--action);
        text-decoration: none;
        font-size: .875rem;
        display: flex;
        align-items: center;
        gap: 4px;
        margin-top: 8px;
    }
    .coupon-message {
        font-size: .875rem;
        margin-top: 8px;
        color: #059669;
    }
    .coupon-message.error {
        color: #DC2626;
    }

    /* Responsive */
    @media (max-width: 960px) {
        .cols { flex-direction: column; }
        .right { flex: 1 1 auto; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <form method="post" action="{% url 'place_order' %}">
        {% csrf_token %}
        <div class="cols">
            <!-- Left Column: Address & Payment -->
            <section class="left">
                <!-- Delivery Address -->
                <div class="section-head">
                    <h2>Delivery Address</h2>
                    <a href="{% url 'add_address' %}?next={{ request.path }}" class="btn">
                        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                        Add New Address
                    </a>
                </div>
                <div class="card address-wrap" aria-label="Selected delivery address">
                    {% for address in addresses %}
                    <div class="address-card {% if address.is_default %}selected{% endif %}" onclick="selectAddress(this, {{ address.id }})" role="group" aria-labelledby="addr-{{ address.id }}-name">
                        <input type="radio" name="address" value="{{ address.id }}" id="addr-{{ address.id }}" class="d-none" {% if address.is_default %}checked{% endif %}>
                        <div class="row">
                            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M4 10.5 12 4l8 6.5V20a1 1 0 0 1-1 1h-5v-6H10v6H5a1 1 0 0 1-1-1v-9.5Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/></svg>
                            <h3 id="addr-{{ address.id }}-name">{{ address.full_name }} <span class="muted">({{ address.address_type|title }})</span></h3>
                            <span class="badge" aria-label="{% if address.is_default %}Selected{% else %}Select{% endif %}">{% if address.is_default %}Selected{% endif %}</span>
                            <div class="meta">
                                <a href="{% url 'edit_address' address.id %}?next={{ request.path }}" aria-label="Edit address">Edit</a>
                            </div>
                        </div>
                        <div class="row muted">
                            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M22 16.92v2a2 2 0 0 1-2.18 2 19.8 19.8 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.08 4.18 2 2 0 0 1 4.06 2h2a2 2 0 0 1 2 1.72c.12.9.31 1.78.58 2.63a2 2 0 0 1-.45 2.11L7.09 9.91a16 16 0 0 0 6 6l1.45-1.1a2 2 0 0 1 2.11-.45c.85.27 1.73.46 2.63.58a2 2 0 0 1 1.72 2Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            {{ address.phone_number }}
                        </div>
                        <div class="row muted">
                            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 21s7-5.33 7-11a7 7 0 1 0-14 0c0 5.67 7 11 7 11Z" stroke="currentColor" stroke-width="1.6"/><circle cx="12" cy="10" r="2.5" fill="currentColor"/></svg>
                            {{ address.address_line_1 }}, {{ address.city }}, {{ address.state }} - {{ address.postal_code }}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Payment Method -->
                <div class="section-head" style="margin-top:18px">
                    <h2>Payment Method</h2>
                </div>
                <div class="methods">
                    <label class="method disabled">
                        <span class="radio" aria-hidden="true"><span class="radio-dot"></span></span>
                        <span>
                            <span class="method-title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none"><rect x="2" y="5" width="20" height="14" rx="3" stroke="currentColor" stroke-width="1.6"/><path d="M2 9h20" stroke="currentColor" stroke-width="1.6"/></svg>
                                Debit/Credit Card (Razorpay)
                            </span>
                            <div class="method-sub">Coming soon.</div>
                        </span>
                    </label>
                    <label class="method is-active">
                        <input type="radio" name="payment_method" value="cod" class="d-none" checked>
                        <span class="radio" aria-hidden="true"><span class="radio-dot"></span></span>
                        <span>
                            <span class="method-title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M4 12h16M4 12a6 6 0 1 1 0-4m16 4a6 6 0 1 0 0-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M6 15h12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
                                Cash on Delivery
                            </span>
                            <div class="method-sub">Pay when you receive your order.</div>
                        </span>
                    </label>
                    <label class="method disabled">
                        <span class="radio" aria-hidden="true"><span class="radio-dot"></span></span>
                        <span>
                            <span class="method-title">
                                <svg class="icon" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="3" stroke="currentColor" stroke-width="1.6"/><path d="M8 13h8M8 10h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
                                Wallet
                            </span>
                            <div class="method-sub">Coming soon.</div>
                        </span>
                    </label>
                </div>
            </section>

            <!-- Right Column: Order Summary -->
            <aside class="right">
                <div class="card summary" aria-label="Order Summary">
                    <h2 style="margin-bottom:6px">Order Summary</h2>
                    {% for item in cart_items %}
                    <div class="item">
                        <img src="{{ item.product.images.first.image.url }}" alt="{{ item.product.name }}" class="thumb">
                        <div>
                            <div class="row inline"><strong>{{ item.product.name }}</strong></div>
                            <div class="muted">Quantity: {{ item.quantity }}</div>
                            <div>
                                <strong>₹{{ item.subtotal|floatformat:2 }}</strong>
                                {% if item.product.original_price %}
                                <span class="muted" style="text-decoration:line-through; margin-left:6px">₹{{ item.product.original_price }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    <div style="height:10px"></div>
                    <h3>Apply Coupon</h3>
                    <div class="coupon">
                        <input class="input" id="coupon-input" placeholder="Enter coupon code" aria-label="Coupon code">
                        <button class="btn-gray" type="button" onclick="applyCoupon()">Apply</button>
                    </div>
                    <div id="coupon-message" class="coupon-message"></div>
                    <a href="#" class="view-coupons">
                        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M6 9h12M6 12h12M6 15h12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
                        View Available Coupons
                    </a>
                </div>
                <div class="card" style="margin-top:16px">
                    <h2>Price Details</h2>
                    <div class="price-row muted"><span>Price Rs.</span><span>₹{{ subtotal|floatformat:2 }}</span></div>
                    {% if discount > 0 %}
                    <div class="price-row discount"><span>Total Discount</span><span>-₹{{ discount|floatformat:2 }}</span></div>
                    {% endif %}
                    <div class="price-row muted"><span>Subtotal ({{ cart_items|length }} items)</span><span>₹{{ subtotal|floatformat:2 }}</span></div>
                    <div class="price-row muted"><span>Tax (18%)</span><span>₹{{ taxes|floatformat:2 }}</span></div>
                    <div class="price-row muted"><span>Shipping</span><span>₹{{ shipping|floatformat:2 }}</span></div>
                    <div class="price-row total"><span>Total</span><span id="total-amount">₹{{ grand_total|floatformat:2 }}</span></div>
                    <input type="hidden" name="coupon_code" id="coupon-code" value="">
                    <button type="submit" class="cta">Place Order</button>
                </div>
            </aside>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Predefined coupons
    const coupons = {
        'SAVE10': { discount: 0.10, minOrder: 500, description: '10% off on orders above ₹500' },
        'FLAT50': { discount: 50, minOrder: 1000, description: '₹50 off on orders above ₹1000' },
        'FIRSTORDER': { discount: 0.15, minOrder: 300, description: '15% off for first orders above ₹300' }
    };

    function selectAddress(element, addressId) {
        // Remove selected class from all cards
        document.querySelectorAll('.address-card').forEach(card => {
            card.classList.remove('selected');
            const badge = card.querySelector('.badge');
            if (badge) badge.textContent = '';
        });
        
        // Add selected class to clicked card
        element.classList.add('selected');
        const badge = element.querySelector('.badge');
        if (badge) badge.textContent = 'Selected';
        
        // Check the corresponding radio button
        document.getElementById('addr-' + addressId).checked = true;
    }

    function applyCoupon() {
        const couponInput = document.getElementById('coupon-input');
        const couponMessage = document.getElementById('coupon-message');
        const couponCodeInput = document.getElementById('coupon-code');
        const totalAmountElement = document.getElementById('total-amount');
        const code = couponInput.value.trim().toUpperCase();
        const subtotal = {{ subtotal|floatformat:2 }};
        let grandTotal = {{ grand_total|floatformat:2 }};

        // Reset previous messages and coupon
        couponMessage.textContent = '';
        couponMessage.classList.remove('error');
        couponCodeInput.value = '';

        if (!code) {
            couponMessage.textContent = 'Please enter a coupon code';
            couponMessage.classList.add('error');
            return;
        }

        if (coupons[code]) {
            const coupon = coupons[code];
            
            // Check minimum order value
            if (subtotal < coupon.minOrder) {
                couponMessage.textContent = `Minimum order of ₹${coupon.minOrder} required for this coupon`;
                couponMessage.classList.add('error');
                return;
            }

            // Calculate discount
            let discountAmount = 0;
            if (coupon.discount < 1) {
                // Percentage discount
                discountAmount = subtotal * coupon.discount;
            } else {
                // Flat discount
                discountAmount = coupon.discount;
            }

            // Update total
            grandTotal = subtotal + {{ taxes|floatformat:2 }} + {{ shipping|floatformat:2 }} - discountAmount;
            
            // Update UI
            couponMessage.textContent = `${coupon.description} applied! ₹${discountAmount.toFixed(2)} saved`;
            totalAmountElement.textContent = `₹${grandTotal.toFixed(2)}`;
            couponCodeInput.value = code;
        } else {
            couponMessage.textContent = 'Invalid coupon code';
            couponMessage.classList.add('error');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Select default address on page load
        const defaultAddress = document.querySelector('input[name="address"]:checked');
        if (defaultAddress) {
            const card = defaultAddress.closest('.address-card');
            card.classList.add('selected');
            const badge = card.querySelector('.badge');
            if (badge) badge.textContent = 'Selected';
        }

        // Add event listener for Enter key on coupon input
        document.getElementById('coupon-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyCoupon();
            }
        });
    });
</script>
{% endblock %}
