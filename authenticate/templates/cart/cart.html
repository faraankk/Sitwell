{% extends 'authenticated_base.html' %}
{% load static %}

{% block title %}Shopping Cart{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <div style="display: grid; grid-template-columns: 1fr 400px; gap: 30px;">
        
        <!-- Cart Items -->
        <div style="background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>Shopping Cart</h2>
                {% if cart_items %}
                <form method="post" action="{% url 'clear_cart' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" onclick="return confirm('Clear cart?')" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                        Clear Cart
                    </button>
                </form>
                {% endif %}
            </div>
            
            {% if not cart_items %}
                <div style="text-align: center; padding: 50px 0;">
                    <i class="fas fa-shopping-cart" style="font-size: 4rem; color: #ccc; margin-bottom: 20px;"></i>
                    <h3>Your cart is empty</h3>
                    <p style="color: #666; margin-bottom: 30px;">Browse our products and add items to your cart</p>
                    <a href="{% url 'product_list' %}" style="background: #db4444; color: white; padding: 12px 24px; text-decoration: none; border-radius: 4px;">Continue Shopping</a>
                </div>
            {% else %}
                {% if unavailable_items %}
                <div style="background: #fff3cd; color: #856404; padding: 12px 20px; border-radius: 4px; margin-bottom: 20px;">
                    <strong>Notice:</strong> Some items are no longer available. Please review your cart.
                </div>
                {% endif %}
                
                <div>
                    {% for item in cart_items %}
                    <div style="display: grid; grid-template-columns: 80px 1fr 100px 80px 100px 50px; gap: 15px; align-items: center; padding: 20px 0; border-bottom: 1px solid #eee; {% if not item.is_available %}opacity: 0.6;{% endif %}">
                        
                        <img src="{% if item.product.get_main_image %}{{ item.product.get_main_image.image.url }}{% else %}{% static 'images/no-image.jpg' %}{% endif %}" 
                             alt="{{ item.product.name }}" 
                             style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                        
                        <div>
                            <h4 style="margin: 0 0 8px 0;">{{ item.product.name }}</h4>
                            {% if not item.is_available %}
                                <small style="color: #dc3545;">
                                    {% if item.product.stock_quantity <= 0 %}Out of stock{% else %}Unavailable{% endif %}
                                </small>
                            {% endif %}
                        </div>
                        
                        <div style="font-weight: 600;">₹{{ item.product.price }}</div>
                        
                        {% if item.is_available %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="quantity-btn" data-action="decrement" data-cart-item-id="{{ item.id }}" 
                                    {% if item.quantity <= 1 %}disabled{% endif %}
                                    style="background: #f5f5f5; border: 1px solid #ddd; width: 30px; height: 30px; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-minus"></i>
                            </button>
                            <span id="quantity-{{ item.id }}">{{ item.quantity }}</span>
                            <button class="quantity-btn" data-action="increment" data-cart-item-id="{{ item.id }}"
                                    {% if item.quantity >= item.max_quantity_allowed %}disabled{% endif %}
                                    style="background: #f5f5f5; border: 1px solid #ddd; width: 30px; height: 30px; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        {% else %}
                        <span>{{ item.quantity }}</span>
                        {% endif %}
                        
                        <div style="font-weight: 600;" id="subtotal-{{ item.id }}">₹{{ item.subtotal }}</div>
                        
                        <form method="post" action="{% url 'remove_from_cart' item.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" style="background: none; border: none; color: #dc3545; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <!-- Order Summary -->
        {% if cart_items %}
        <div style="background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); height: fit-content;">
            <h3 style="margin-bottom: 20px;">Order Summary</h3>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <span>Items ({{ total_items }}):</span>
                <span id="cart-total">₹{{ total_amount }}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <span>Shipping:</span>
                <span>Free</span>
            </div>
            
            <hr style="margin: 20px 0;">
            
            <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: 600; margin-bottom: 25px;">
                <span>Total:</span>
                <span id="final-total">₹{{ total_amount }}</span>
            </div>
            
            {% if can_checkout %}
            <a href="{% url 'checkout' %}" style="display: block; width: 100%; background: #db4444; color: white; border: none; padding: 15px; border-radius: 4px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px; text-align: center; text-decoration: none;">
                Proceed to Checkout
            </a>

            {% else %}
            <button disabled style="width: 100%; background: #6c757d; color: white; border: none; padding: 15px; border-radius: 4px; font-size: 16px; margin-bottom: 15px;">
                Cannot Proceed - Items Unavailable
            </button>
            {% endif %}
            
            <a href="{% url 'product_list' %}" style="width: 100%; background: none; color: #db4444; border: 1px solid #db4444; padding: 15px; border-radius: 4px; text-decoration: none; display: block; text-align: center;">
                Continue Shopping
            </a>
        </div>
        {% endif %}
        
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.quantity-btn').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.dataset.action;
            const cartItemId = this.dataset.cartItemId;
            
            fetch('{% url "update_cart_quantity" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `cart_item_id=${cartItemId}&action=${action}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`quantity-${cartItemId}`).textContent = data.new_quantity;
                    document.getElementById(`subtotal-${cartItemId}`).textContent = `₹${data.item_subtotal}`;
                    document.getElementById('cart-total').textContent = `₹${data.cart_total}`;
                    document.getElementById('final-total').textContent = `₹${data.cart_total}`;
                    
                    const decrementBtn = document.querySelector(`[data-cart-item-id="${cartItemId}"][data-action="decrement"]`);
                    const incrementBtn = document.querySelector(`[data-cart-item-id="${cartItemId}"][data-action="increment"]`);
                    
                    decrementBtn.disabled = data.new_quantity <= 1;
                } else {
                    alert(data.message);
                }
            });
        });
    });
});
</script>
{% endblock %}
