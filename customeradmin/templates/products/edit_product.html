{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Product - {{ product.name }} - Sitwell Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .dashboard-bg {
            background: linear-gradient(135deg, #f8f9ff 0%, #fff5f8 100%);
        }
        
        .sidebar-gradient {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        }
        
        .sidebar-item {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .sidebar-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: white;
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        .sidebar-item:hover::before,
        .sidebar-item.active::before {
            transform: scaleY(1);
        }
        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        
        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .file-upload-area {
            border: 3px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        .file-upload-area:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #fff5f8 100%);
        }
        .file-upload-area.dragover {
            border-color: #667eea;
            background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
            transform: scale(1.02);
        }
    </style>
</head>
<body class="dashboard-bg min-h-screen">
    <div class="flex h-screen overflow-hidden">
        <!-- Enhanced Sidebar -->
        <aside class="w-72 sidebar-gradient shadow-2xl flex-shrink-0">
            <div class="p-6 border-b border-white/20">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg">
                        <span class="text-2xl font-black" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">SW</span>
                    </div>
                    <div class="ml-3">
                        <span class="text-xl font-black text-white">sitwell</span>
                        <p class="text-xs text-white/70">Admin Portal</p>
                    </div>
                </div>
            </div>
            
            <nav class="mt-6 px-4 pb-6 overflow-y-auto" style="max-height: calc(100vh - 120px);">
                <div class="text-xs font-bold text-white/50 uppercase tracking-wider mb-4 px-3">MAIN MENU</div>
                
                <div class="space-y-2">
                    <a href="{% url 'admin_dashboard' %}" class="sidebar-item flex items-center px-4 py-3 text-sm font-medium text-white/80 hover:text-white rounded-xl">
                        <i class="fas fa-home w-5 text-center mr-3 text-lg"></i>
                        <span>Dashboard</span>
                    </a>
                    
                    <a href="{% url 'product-list' %}" class="sidebar-item active flex items-center px-4 py-3 text-sm font-medium text-white rounded-xl">
                        <i class="fas fa-box w-5 text-center mr-3 text-lg"></i>
                        <span>Products</span>
                    </a>
                    
                    <a href="{% url 'category-list' %}" class="sidebar-item flex items-center px-4 py-3 text-sm font-medium text-white/80 hover:text-white rounded-xl">
                        <i class="fas fa-tags w-5 text-center mr-3 text-lg"></i>
                        <span>Categories</span>
                    </a>
                    
                    <a href="{% url 'user-management' %}" class="sidebar-item flex items-center px-4 py-3 text-sm font-medium text-white/80 hover:text-white rounded-xl">
                        <i class="fas fa-users-cog w-5 text-center mr-3 text-lg"></i>
                        <span>User Management</span>
                    </a>
                    
                    <a href="{% url 'customer-list' %}" class="sidebar-item flex items-center px-4 py-3 text-sm font-medium text-white/80 hover:text-white rounded-xl">
                        <i class="fas fa-users w-5 text-center mr-3 text-lg"></i>
                        <span>Customers</span>
                    </a>
                    
                    <div class="mt-6 pt-6 border-t border-white/20">
                        <form action="{% url 'admin_logout' %}" method="post" style="width: 100%;">
                            {% csrf_token %}
                            <button type="submit" class="sidebar-item flex items-center px-4 py-3 text-sm font-medium text-white/80 hover:text-white rounded-xl w-full text-left border-none bg-transparent cursor-pointer">
                                <i class="fas fa-sign-out-alt w-5 text-center mr-3 text-lg"></i>
                                <span>Logout</span>
                            </button>
                        </form>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Enhanced Header -->
            <header class="bg-white shadow-sm border-b border-gray-100 px-8 py-5 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-black" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Edit Product</h1>
                        <nav class="flex items-center space-x-2 text-sm text-gray-500 mt-2">
                            <a href="{% url 'admin_dashboard' %}" class="text-purple-600 hover:text-purple-800 font-medium transition-colors">
                                <i class="fas fa-home mr-1"></i>Dashboard
                            </a>
                            <i class="fas fa-chevron-right text-xs"></i>
                            <a href="{% url 'product-list' %}" class="text-purple-600 hover:text-purple-800 font-medium transition-colors">Products</a>
                            <i class="fas fa-chevron-right text-xs"></i>
                            <span class="font-medium">Edit Product</span>
                        </nav>
                    </div>
                    <div class="flex items-center space-x-3 bg-gradient-to-r from-blue-50 to-purple-50 px-4 py-2 rounded-xl">
                        <div class="w-2 h-2 bg-green-500 rounded-full pulse"></div>
                        <span class="text-sm font-bold text-gray-700">Farhaan</span>
                        <span class="text-xs text-gray-500 font-medium">Admin</span>
                    </div>
                </div>
            </header>

            <!-- Form Content -->
            <main class="flex-1 overflow-auto p-8">
                <!-- Messages -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="mb-6 p-4 rounded-xl fade-in {% if message.tags == 'error' %}bg-red-50 border-2 border-red-200 text-red-800{% else %}bg-green-50 border-2 border-green-200 text-green-800{% endif %}">
                            <div class="flex items-center">
                                <i class="fas {% if message.tags == 'error' %}fa-times-circle{% else %}fa-check-circle{% endif %} text-2xl mr-3"></i>
                                <span class="font-semibold">{{ message }}</span>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}

                <form method="POST" enctype="multipart/form-data" class="max-w-7xl mx-auto" id="product-form">
                    {% csrf_token %}
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Main Product Information -->
                        <div class="lg:col-span-2 space-y-8">
                            <!-- General Information -->
                            <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-100 p-8 fade-in">
                                <div class="flex items-center mb-6">
                                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mr-4">
                                        <i class="fas fa-info-circle text-white text-xl"></i>
                                    </div>
                                    <h2 class="text-2xl font-black text-gray-900">General Information</h2>
                                </div>
                                
                                <div class="space-y-5">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Product Name *</label>
                                        <input type="text" name="name" value="{{ product.name }}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium transition-all" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">SKU *</label>
                                        <input type="text" name="sku" value="{{ product.sku }}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium transition-all" required>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                        <div>
                                            <label class="block text-sm font-bold text-gray-700 mb-2">Category *</label>
                                            <select name="category" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium transition-all" required>
                                                <option value="">Select category</option>
                                                <option value="sofa" {% if product.category == "sofa" %}selected{% endif %}>Sofa</option>
                                                <option value="chair" {% if product.category == "chair" %}selected{% endif %}>Chair</option>
                                                <option value="table" {% if product.category == "table" %}selected{% endif %}>Table</option>
                                                <option value="bed" {% if product.category == "bed" %}selected{% endif %}>Bed</option>
                                                <option value="storage" {% if product.category == "storage" %}selected{% endif %}>Storage</option>
                                                <option value="accessories" {% if product.category == "accessories" %}selected{% endif %}>Accessories</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-bold text-gray-700 mb-2">Brand</label>
                                            <input type="text" name="brand" value="{{ product.brand }}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium transition-all">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Description -->
                            <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-100 p-8 fade-in" style="animation-delay: 0.1s;">
                                <div class="flex items-center mb-6">
                                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center mr-4">
                                        <i class="fas fa-align-left text-white text-xl"></i>
                                    </div>
                                    <h2 class="text-2xl font-black text-gray-900">Description</h2>
                                </div>
                                
                                <div class="space-y-5">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Short Description</label>
                                        <textarea name="short_description" rows="3" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium transition-all">{{ product.short_description }}</textarea>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Detailed Description</label>
                                        <textarea name="detailed_description" rows="6" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium transition-all">{{ product.detailed_description }}</textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Current Images -->
                            <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-100 p-8 fade-in" style="animation-delay: 0.2s;">
                                <div class="flex items-center mb-6">
                                    <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center mr-4">
                                        <i class="fas fa-images text-white text-xl"></i>
                                    </div>
                                    <h2 class="text-2xl font-black text-gray-900">Current Images</h2>
                                </div>
                                
                                <div class="image-preview-grid">
                                    {% for image in product.images.all %}
                                    <div class="relative group bg-gray-100 rounded-xl overflow-hidden border-2 border-gray-200">
                                        <img src="{{ image.image.url }}" alt="Product Image" class="w-full h-40 object-cover">
                                        <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                            <button type="button" onclick="deleteImage({{ image.id }})" class="bg-red-600 text-white px-4 py-2 rounded-xl hover:bg-red-700 font-bold">
                                                <i class="fas fa-trash mr-2"></i>Delete
                                            </button>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="col-span-full text-center py-8 text-gray-500">
                                        No images uploaded yet
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Upload New Images -->
                            <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-100 p-8 fade-in" style="animation-delay: 0.3s;">
                                <div class="flex items-center mb-6">
                                    <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl flex items-center justify-center mr-4">
                                        <i class="fas fa-cloud-upload-alt text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h2 class="text-2xl font-black text-gray-900">Add New Images</h2>
                                        <p class="text-sm text-gray-500 mt-1">Upload additional images (JPG, PNG, GIF, WebP - Max 5MB each)</p>
                                    </div>
                                </div>
                                
                                <div class="file-upload-area rounded-2xl p-10 text-center cursor-pointer" onclick="document.getElementById('new-images').click()">
                                    <div class="mx-auto w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center text-white mb-4 shadow-lg">
                                        <i class="fas fa-folder-open text-3xl"></i>
                                    </div>
                                    <p class="text-xl font-bold text-gray-700 mb-2">Click to upload new images</p>
                                    <p class="text-sm text-gray-500">or drag and drop files here</p>
                                    <input type="file" id="new-images" name="new_images" accept="image/*" multiple style="position: absolute; left: -9999px; opacity: 0;">
                                </div>
                                
                                <div id="new-preview-container" class="hidden mt-6">
                                    <h3 class="text-lg font-bold text-gray-700 mb-4">New Images Selected (<span id="new-image-count">0</span>)</h3>
                                    <div id="new-preview-grid" class="image-preview-grid"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar Forms -->
                        <div class="space-y-8">
                            <!-- Pricing -->
                            <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-100 p-6 fade-in" style="animation-delay: 0.1s;">
                                <div class="flex items-center mb-5">
                                    <div class="w-10 h-10 bg-gradient-to-br from-yellow-500 to-orange-600 rounded-xl flex items-center justify-center mr-3">
                                        <i class="fas fa-dollar-sign text-white text-lg"></i>
                                    </div>
                                    <h2 class="text-xl font-black text-gray-900">Pricing</h2>
                                </div>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Base Price (â‚¹) *</label>
                                        <input type="number" step="0.01" name="price" value="{{ product.price }}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium transition-all" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Discount Type</label>
                                        <select name="discount_type" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium transition-all">
                                            <option value="none" {% if product.discount_type == "none" %}selected{% endif %}>No Discount</option>
                                            <option value="percentage" {% if product.discount_type == "percentage" %}selected{% endif %}>Percentage</option>
                                            <option value="fixed" {% if product.discount_type == "fixed" %}selected{% endif %}>Fixed Amount</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Discount Value</label>
                                        <input type="number" step="0.01" name="discount_value" value="{{ product.discount_value }}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium transition-all">
                                    </div>
                                </div>
                            </div>

                            <!-- Inventory -->
                            <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-100 p-6 fade-in" style="animation-delay: 0.2s;">
                                <div class="flex items-center mb-5">
                                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-3">
                                        <i class="fas fa-warehouse text-white text-lg"></i>
                                    </div>
                                    <h2 class="text-xl font-black text-gray-900">Inventory</h2>
                                </div>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Stock Quantity *</label>
                                        <input type="number" name="stock_quantity" value="{{ product.stock_quantity }}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium transition-all" required>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Low Stock Threshold</label>
                                        <input type="number" name="low_stock_threshold" value="{{ product.low_stock_threshold }}" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium transition-all">
                                    </div>
                                </div>
                            </div>

                            <!-- Product Status -->
                            <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-100 p-6 fade-in" style="animation-delay: 0.3s;">
                                <div class="flex items-center mb-5">
                                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-teal-600 rounded-xl flex items-center justify-center mr-3">
                                        <i class="fas fa-toggle-on text-white text-lg"></i>
                                    </div>
                                    <h2 class="text-xl font-black text-gray-900">Status</h2>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Product Status *</label>
                                    <select name="status" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-medium transition-all" required>
                                        <option value="draft" {% if product.status == "draft" %}selected{% endif %}>Draft</option>
                                        <option value="published" {% if product.status == "published" %}selected{% endif %}>Published</option>
                                        <option value="out-of-stock" {% if product.status == "out-of-stock" %}selected{% endif %}>Out of Stock</option>
                                        <option value="low-stock" {% if product.status == "low-stock" %}selected{% endif %}>Low Stock</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-10 flex justify-between items-center fade-in" style="animation-delay: 0.4s;">
                        <a href="{% url 'product-list' %}" class="px-8 py-4 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all font-bold">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </a>
                        
                        <button type="submit" class="px-10 py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-bold text-lg hover:shadow-2xl transition-all">
                            <i class="fas fa-save mr-2"></i>Update Product
                        </button>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function deleteImage(imageId) {
            if (!confirm('Are you sure you want to delete this image?')) return;
            
            fetch(`/staff/products/delete-image/${imageId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error deleting image: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error deleting image');
                console.error('Error:', error);
            });
        }

        // New images preview
        const newImagesInput = document.getElementById('new-images');
        const newPreviewContainer = document.getElementById('new-preview-container');
        const newPreviewGrid = document.getElementById('new-preview-grid');
        const newImageCount = document.getElementById('new-image-count');

        newImagesInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            newPreviewGrid.innerHTML = '';
            newPreviewContainer.classList.remove('hidden');
            newImageCount.textContent = files.length;

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'relative group bg-gray-100 rounded-xl overflow-hidden border-2 border-gray-200 hover:border-purple-500 transition-all';
                    div.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-40 object-cover" alt="New Image ${index + 1}">
                        <div class="absolute top-2 left-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white text-xs px-3 py-1 rounded-full font-bold">
                            New #${index + 1}
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent text-white text-xs p-2 truncate font-medium">
                            ${file.name}
                        </div>
                    `;
                    newPreviewGrid.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        });
    </script>
</body>
</html>
