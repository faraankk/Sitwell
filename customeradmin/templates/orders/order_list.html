{# templates/orders/order_list.html #}
{% extends "admin/base_admin.html" %}
{% block body %}
<div class="flex items-center justify-between mb-4">
  <h1 class="text-2xl font-semibold">Orders</h1>
</div>

<form method="get" class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4">
  <input name="search" value="{{ searchquery }}" placeholder="Search order/user" class="px-3 py-2 border rounded col-span-2">
  <select name="status" class="px-3 py-2 border rounded">
    <option value="all" {% if currentstatus == 'all' or not currentstatus %}selected{% endif %}>All</option>
    {% for val,label in statuschoices %}
      <option value="{{ val }}" {% if currentstatus == val %}selected{% endif %}>{{ label }}</option>
    {% endfor %}
  </select>
  <input type="date" name="from" value="{{ datefrom }}" class="px-3 py-2 border rounded">
  <input type="date" name="to" value="{{ dateto }}" class="px-3 py-2 border rounded">
  <select name="sort" class="px-3 py-2 border rounded">
    <option value="datedesc" {% if sort == 'datedesc' %}selected{% endif %}>Newest</option>
    <option value="dateasc" {% if sort == 'dateasc' %}selected{% endif %}>Oldest</option>
    <option value="totaldesc" {% if sort == 'totaldesc' %}selected{% endif %}>Total High→Low</option>
    <option value="totalasc" {% if sort == 'totalasc' %}selected{% endif %}>Total Low→High</option>
  </select>
  <div class="flex gap-2">
    <button class="px-4 py-2 bg-blue-600 text-white rounded" type="submit">Search</button>
    <a href="{% url 'order-list' %}?clear=1" class="px-4 py-2 bg-gray-200 rounded">Clear</a>
  </div>
</form>

<div class="overflow-x-auto bg-white rounded border">
  <table class="min-w-full text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="text-left px-4 py-2">Order ID</th>
        <th class="text-left px-4 py-2">Date</th>
        <th class="text-left px-4 py-2">User</th>
        <th class="text-left px-4 py-2">Items</th>
        <th class="text-right px-4 py-2">Total</th>
        <th class="text-left px-4 py-2">Status</th>
        <th class="px-4 py-2">Action</th>
      </tr>
    </thead>
    <tbody>
      {% for o in orders %}
      <tr class="border-t">{{ o.order_number }}
        <td class="px-4 py-2 font-medium"></td>
        <td class="px-4 py-2">{{ o.created_at|date:"Y-m-d H:i" }}</td>
        <td class="px-4 py-2">
          {% if o.user.first_name %}{{ o.user.first_name }} {{ o.user.last_name }}{% else %}{{ o.user.username }}{% endif %}
          <div class="text-gray-500 text-xs">{{ o.user.email }}</div>
        </td>
        <td class="px-4 py-2">{{ o.items.count }}</td>
        <td class="px-4 py-2 text-right">{{ o.total_amount }}</td>
        <td class="px-4 py-2">
          {% with s=o.status %}
            {% if s == 'pending' %}
              <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-800"><span class="w-2 h-2 rounded-full bg-amber-500"></span>Pending</span>
            {% elif s == 'paid' %}
              <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium bg-sky-100 text-sky-800"><span class="w-2 h-2 rounded-full bg-sky-500"></span>Paid</span>
            {% elif s == 'shipped' %}
              <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800"><span class="w-2 h-2 rounded-full bg-indigo-500"></span>Shipped</span>
            {% elif s == 'out-for-delivery' %}
              <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><span class="w-2 h-2 rounded-full bg-yellow-500"></span>Out for Delivery</span>
            {% elif s == 'delivered' %}
              <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"><span class="w-2 h-2 rounded-full bg-green-500"></span>Delivered</span>
            {% elif s == 'cancelled' %}
              <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium bg-rose-100 text-rose-800"><span class="w-2 h-2 rounded-full bg-rose-500"></span>Cancelled</span>
            {% else %}
              <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800"><span class="w-2 h-2 rounded-full bg-gray-500"></span>{{ o.get_status_display }}</span>
            {% endif %}
          {% endwith %}
        </td>
        <td class="px-4 py-2">
        <form method="post" action="{% url 'order-update-status' o.id %}" class="flex items-center gap-2">
            {% csrf_token %}
            <select name="status" class="px-2 py-1 border rounded text-xs">
            {% for val,label in statuschoices %}
                {% if val != 'cancelled' %}
                <option value="{{ val }}" {% if o.status == val %}selected{% endif %}>{{ label }}</option>
                {% endif %}
            {% endfor %}
            </select>
            <button type="submit" class="px-3 py-1 rounded text-xs bg-blue-600 text-white hover:bg-blue-700">Update</button>
        </form>
        </td>
        <td class="px-4 py-2">
          <a href="{% url 'order-detail' o.id %}" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">View</a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="7" class="px-4 py-6 text-center text-gray-500">No orders found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="mt-4 flex items-center justify-between">
  <div class="text-sm text-gray-600">Total {{ totalorders }}</div>
  {% if pageobj.has_other_pages %}
    <div class="flex gap-2">
      {% if pageobj.has_previous %}
        <a class="px-3 py-1 border rounded" href="?page={{ pageobj.previous_page_number }}&search={{ searchquery }}&status={{ currentstatus }}&sort={{ sort }}&from={{ datefrom }}&to={{ dateto }}">Prev</a>
      {% endif %}
      <span class="px-3 py-1 border rounded bg-gray-100">{{ pageobj.number }} / {{ pageobj.paginator.num_pages }}</span>
      {% if pageobj.has_next %}
        <a class="px-3 py-1 border rounded" href="?page={{ pageobj.next_page_number }}&search={{ searchquery }}&status={{ currentstatus }}&sort={{ sort }}&from={{ datefrom }}&to={{ dateto }}">Next</a>
      {% endif %}
    </div>
  {% endif %}
</div>
{% endblock %}
